<%
# default
user = 'nobody'
case node.platform_family
  when 'debian' # matches debian ubuntu mint scientific etc
    user = 'www-data'
  when 'rhel' # matches redhat centos etc
    user = 'nginx'
  end
%>

user <%= user %>;

# Default: as many as CPU cores
worker_processes <%= File.read('/proc/cpuinfo').split("\n").grep(/^processor\t/).count %>;
pid /var/run/nginx.pid;

events {
  worker_connections 2048;
}

http {

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 10;
  types_hash_max_size 2048;
  server_common_names_hash_bucket_size 128;
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;

  gzip on;
  gzip_disable "msie6";

  include /etc/nginx/conf.d/*.conf;


# Autogenerated part of config

  <%
    node.cdn.vhosts.each do |common_name|
  %>

    server {
      listen <%= common_name['port'] %> ;
#      listen 443 ssl;
      server_name <%= common_name['vhost'] %>;
      access_log /var/logs/nginx/<%= common_name['vhost'] %>-access.log;

#      ssl_certificate      <%= common_name['vhost'] %>.crt;
#      ssl_certificate_key  <%= common_name['vhost'] %>.key;

      root /usr/share/nginx/<%= common_name['vhost'] %>/html;
      index index.html index.htm;

      location / {
        try_files $uri $uri/ /index.html;
      }

    }

  <% end %>

}
